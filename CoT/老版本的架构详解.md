# 回复生成模块架构详解

## 一、模块定位

回复生成模块是审讯系统的语言输出核心，负责将策略模块选定的策略转化为自然、拟人化的嫌疑人回复。该模块的核心目标是解决"回复生硬、前后矛盾"的问题，通过多源联动和精准的风格控制，生成符合嫌疑人角色设定的自然语言回复。

### 1.1 核心职责

- **策略适配**：根据选定策略生成符合其逻辑的回复内容
- **风格控制**：根据嫌疑人侧写和心理状态调整语言风格
- **知识注入**：从DLKG知识库中获取相关信息，保证逻辑一致性
- **一致性校验**：检查回复是否与已知事实矛盾
- **记忆回写**：将新信息回写到知识库

### 1.2 在系统中的位置

```
┌─────────────────────────────────────────────────────────────┐
│                      审讯系统架构                            │
├─────────────────────────────────────────────────────────────┤
│  感知模块 → 策略模块 → [回复生成模块] → 输出                  │
│      ↓           ↓            ↓              ↓              │
│  意图识别    策略选择    候选人回复      自然语言            │
│  证据分析    心理评估    风格控制        对话               │
│  实体识别    状态追踪    知识整合                          │
└─────────────────────────────────────────────────────────────┘
```

## 二、整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     回复生成模块架构                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │
│  │ 嫌疑人侧写   │    │ 心理状态    │    │ DLKG知识库  │             │
│  │   Manager   │    │   Manager   │    │   Manager   │             │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘             │
│         │                  │                  │                      │
│         └──────────────────┼──────────────────┘                      │
│                            ↓                                         │
│                   ┌─────────────────┐                                │
│                   │  整合输入要素    │                                │
│                   └────────┬────────┘                                │
│                            ↓                                         │
│         ┌──────────────────┼──────────────────┐                      │
│         ↓                  ↓                  ↓                      │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐               │
│  │ 策略适配器   │   │ 风格应用器   │   │ 知识注入器   │               │
│  │   Adapter   │   │   Stylizer  │   │  Injector   │               │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘               │
│         │                  │                  │                      │
│         └──────────────────┼──────────────────┘                      │
│                            ↓                                         │
│                   ┌─────────────────┐                                │
│                   │  一致性校验器    │                                │
│                   └────────┬────────┘                                │
│                            ↓                                         │
│                   ┌─────────────────┐                                │
│                   │  生成最终输出    │                                │
│                   └─────────────────┘                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 文件结构

```
generate_result/
├── __init__.py                    # 包初始化，导出公共接口
├── models.py                      # 数据模型定义（Pydantic）
│   ├── SuspectProfile             # 嫌疑人侧写模型
│   ├── PsychologicalState         # 心理状态模型
│   ├── DLKGRetrievalResult        # DLKG检索结果模型
│   ├── SelectedStrategy           # 策略选择模型
│   ├── ResponseGenerationInput    # 输入模型
│   └── ResponseGenerationOutput   # 输出模型
│
├── suspect_profile.py             # 嫌疑人侧写管理器
│   └── SuspectProfileManager      # 性格特征、说话风格管理
│
├── psychological_state.py         # 心理状态管理器
│   └── PsychologicalStateManager  # 状态转换、风格应用
│
├── dlkg_manager.py                # DLKG知识图谱管理器
│   └── DLKGManager                # 三元组管理、知识检索
│
├── strategy_adapter.py            # 策略适配器
│   └── StrategyAdapter            # 策略模板选择、策略应用
│
├── consistency_checker.py         # 一致性校验器
│   └── ConsistencyChecker         # 矛盾检测、一致性评分
│
├── response_generator.py          # 核心生成器
│   └── ResponseGenerator          # 整合各组件生成回复
│       ResponseGeneratorWithLLM   # LLM增强版本
│
├── examples.py                    # 使用示例
│
└── langgraph/
    ├── __init__.py
    └── workflow.py                # LangGraph工作流定义
        └── create_response_generation_graph()  # 创建状态图
```

## 三、核心模块详解

### 3.1 数据模型层 (models.py)

#### SuspectProfile - 嫌疑人侧写

```python
class SuspectProfile(BaseModel):
    personality: List[str]      # 性格特征列表
    speech_style: List[str]     # 说话风格列表
    background: List[str]       # 背景信息列表
```

**性格特征**：
- 傲慢：高傲、质疑审讯方、强调程序正义
- 狡猾：精明、善于辩解、寻找借口
- 老实：坦诚、容易紧张、配合度高
- 暴躁：易怒、情绪化、反应激烈
- 冷静：镇定、思维清晰、不易露馅

**说话风格**：
- 打官腔：使用正式语言、引用规章制度
- 反问：以问代答、质疑对方
- 磕巴：说话不连贯、频繁停顿
- 啰嗦：详述细节、反复解释
- 简洁：简短回答、避免多说

#### PsychologicalState - 心理状态

```python
class PsychologicalState(BaseModel):
    state: PsychologicalStateEnum  # 状态类型
    defense_value: int            # 防御值 0-100
    stress_value: int             # 压力值 0-100
```

**状态转换规则**：

| 防御值 | 压力值 | 状态 | 语言特征 |
|-------|-------|------|---------|
| > 80 | 任意 | CALM | 正式语言、完整句子、肯定句 |
| 50-80 | < 40 | DEFENSIVE | 反问句、质疑证据、强调程序 |
| 50-80 | 40-70 | ANXIOUS | 短句、结巴、重复、语气词 |
| 20-50 | 任意 | HESITANT | 犹豫、部分承认、找借口 |
| ≤ 20 | 任意 | BROKEN | 完全认罪、积极配合、主动交代 |

#### DLKGRetrievalResult - 知识库检索结果

```python
class DLKGRetrievalResult(BaseModel):
    fact_layer: List[tuple]      # 事实层三元组
    false_layer: List[tuple]     # 虚假层三元组
    casual_layer: List[tuple]    # 闲聊层三元组
```

**DLKG三层结构**：
- 事实层：涉案资金、行贿方、时间地点等核心事实
- 虚假层：借口逻辑、话术模板等虚假信息
- 闲聊层：背景信息、人物关系等上下文信息

#### SelectedStrategy - 选定策略

```python
class SelectedStrategy(BaseModel):
    type: StrategyTypeEnum        # 策略类型
    confidence: float             # 置信度
    parameters: Dict[str, Any]    # 策略参数
```

**策略类型**：

| 策略 | 核心逻辑 | 回复特征 |
|-----|---------|---------|
| DIRECT_DENIAL | 愤怒反驳、倒打一耙 | 情绪化否定、质疑审讯方 |
| FEIGN_IGNORANCE | 以失忆回避问题 | 记忆模糊、推诿他人 |
| RATIONALIZATION | 正常往来解释 | 承认行为、否认性质 |
| RED_HERRING | 偷换概念 | 承认表面、否认动机 |
| PARTIAL_ADMISSION | 承认边缘事实 | 承认小错、否认大错 |
| FULL_CONFESSION | 彻底认罪 | 全面交代、放弃抵抗 |

### 3.2 嫌疑人侧写管理器 (suspect_profile.py)

**核心类**：SuspectProfileManager

**主要功能**：
1. 获取性格特征信息
2. 获取说话风格信息
3. 生成风格修饰符
4. 融合策略调整

**风格修饰符示例**：

```python
def get_style_modifiers(self) -> Dict[str, Any]:
    modifiers = {
        "formality": "neutral",      # 正式程度
        "verbosity": "medium",       # 冗长度
        "emotional_intensity": "low", # 情绪强度
        "cooperativeness": "low",    # 配合度
        "defensiveness": "low"       # 防御性
    }
    
    # 根据性格特征调整
    if "傲慢" in self.profile.personality:
        modifiers["defensiveness"] = "high"
        modifiers["emotional_intensity"] = "medium"
    
    if "狡猾" in self.profile.personality:
        modifiers["verbosity"] = "high"
        modifiers["defensiveness"] = "medium"
    
    if "老实" in self.profile.personality:
        modifiers["cooperativeness"] = "high"
        modifiers["defensiveness"] = "low"
    
    return modifiers
```

### 3.3 心理状态管理器 (psychological_state.py)

**核心类**：PsychologicalStateManager

**主要功能**：
1. 根据防御值和压力值确定心理状态
2. 获取语言特征配置
3. 应用风格到回复文本

**风格转换方法**：

```python
def apply_style_to_response(self, response: str, style_type: str = "positive") -> str:
    """将心理状态风格应用到回复文本"""
    transformers = self.get_sentence_transformers()
    styled_response = response
    
    if transformers["to_stutter"]:
        styled_response = self._add_stutter(styled_response)
    
    if transformers["to_short"]:
        styled_response = self._fragment_sentence(styled_response)
    
    if transformers["to_question"]:
        styled_response = self._to_rhetorical_question(styled_response)
    
    if transformers["to_hesitant"]:
        styled_response = self._add_hesitation(styled_response)
    
    if transformers["to_confessional"]:
        styled_response = self._to_confessional(styled_response)
    
    return styled_response
```

**示例效果**：

| 心理状态 | 原句 | 转换后 |
|---------|-----|-------|
| ANXIOUS | "我没收到过" | "我…… 没收到过…… 真的" |
| DEFENSIVE | "我没收钱" | "你们有证据吗？凭什么说我收了钱？" |
| HESITANT | "是借款" | "其实…… 是借款，应该…… 应该是吧" |
| BROKEN | "我交代" | "我全说…… 我交代，我都交代" |

### 3.4 DLKG管理器 (dlkg_manager.py)

**核心类**：DLKGManager

**主要功能**：
1. 管理知识库三层结构
2. 检索相关三元组
3. 提取新实体
4. 检查一致性
5. 回写新知识

**关键方法**：

```python
def format_triplets_for_prompt(self, max_triplets: int = 5) -> str:
    """格式化三元组用于提示词"""
    triplets = self.get_all_triplets()[:max_triplets]
    formatted = []
    for t in triplets:
        formatted.append(f"({t.subject}, {t.relation}, {t.object})")
    return " | ".join(formatted)

def merge_with_known_facts(self, text: str) -> str:
    """将已知事实融入文本"""
    triplets = self.get_all_triplets()
    if not triplets:
        return text
    
    relevant_info = []
    for triplet in triplets[:5]:
        relevant_info.append(f"{triplet.subject}{triplet.relation}{triplet.object}")
    
    if relevant_info:
        context_insert = f"（背景：{'，'.join(relevant_info)}）"
        return text + context_insert
    
    return text
```

### 3.5 策略适配器 (strategy_adapter.py)

**核心类**：StrategyAdapter

**主要功能**：
1. 根据策略类型选择模板
2. 应用侧写调整
3. 生成策略指令

**策略配置示例**：

```python
STRATEGY_CONFIGS = {
    StrategyTypeEnum.RED_HERRING: {
        "core_logic": "偷换概念",
        "template_structure": [
            "承认表面（如：是收了）",
            "否认动机（如：但不是好处费）",
            "新解释（如：是借款/帮忙/理财）"
        ],
        "required_elements": ["承认表面", "否认动机", "新解释"],
        "strategy_markers": ["承认表面事实", "否认犯罪动机", "偷换概念"],
        "example_responses": [
            "钱是收了，但那不是好处费！是他公司资金周转不开，硬塞给我的借款。",
            "我是帮他理财，不是受贿。他说给我点辛苦费而已。"
        ]
    }
}
```

**侧写适配示例**：

```python
def apply_profile_adaptation(self, base_template: str, profile: SuspectProfile) -> str:
    """根据嫌疑人侧写调整模板"""
    adapted = base_template
    
    if "傲慢" in profile.personality:
        adapted = self._add_arrogance(adapted)
    
    if "狡猾" in profile.personality:
        adapted = self._add_cunning(adapted)
    
    if "打官腔" in profile.speech_style:
        adapted = self._add_official_tone(adapted)
    
    return adapted
```

### 3.6 一致性校验器 (consistency_checker.py)

**核心类**：ConsistencyChecker

**主要功能**：
1. 检查回复与知识库的一致性
2. 检测自相矛盾
3. 检查时间线一致性
4. 生成修复建议

**校验流程**：

```python
def check_response_consistency(self, response: str) -> Tuple[bool, List[str], float]:
    """检查回复的一致性"""
    issues = []
    score = 1.0
    
    extracted_triplets = self._extract_triplets_from_response(response)
    
    # 检查事实一致性
    for triplet in extracted_triplets:
        if triplet.layer == "fact":
            issue = self._check_fact_consistency(triplet)
            if issue:
                issues.append(issue)
                score -= 0.1
    
    # 检查自相矛盾
    if self._check_self_contradiction(response):
        issues.append("回复存在自相矛盾")
        score -= 0.2
    
    # 检查时间线
    if self._check_timeline_consistency(response):
        issues.append("时间线存在不一致")
        score -= 0.1
    
    score = max(0.0, score)
    return len(issues) == 0, issues, score
```

### 3.7 核心生成器 (response_generator.py)

**核心类**：ResponseGenerator

**生成流程**：

```python
def generate_response(self) -> ResponseGenerationOutput:
    """生成回复的完整流程"""
    step_1_context = self._integrate_inputs()      # 整合输入
    step_2_template = self._select_template()      # 选择模板
    step_3_styled = self._apply_style(step_2_template)  # 应用风格
    step_4_enhanced = self._inject_knowledge(step_3_styled)  # 注入知识
    step_5_validated, final_response = self._validate_and_fix(step_4_enhanced)  # 校验
    step_6_output = self._finalize_output(final_response)  # 生成输出
    
    return step_6_output
```

**LLM增强版本**：

```python
class ResponseGeneratorWithLLM:
    """基于LLM的回复生成器（高级版本）"""
    
    def __init__(self, input_data: ResponseGenerationInput, llm_client=None):
        self.input = input_data
        self.llm_client = llm_client  # LLM客户端（如OpenAI、Anthropic）
    
    def generate_response(self) -> ResponseGenerationOutput:
        """使用LLM生成回复"""
        if self.llm_client is None:
            return self._fallback_generate()
        
        prompt = self._build_llm_prompt()
        llm_response = self.llm_client.generate(prompt)
        
        # 后处理
        response = self._parse_llm_response(llm_response)
        
        # 一致性校验
        is_consistent, issues, score = self.consistency_checker.check_response_consistency(response)
        if not is_consistent:
            response, fixed = self.consistency_checker.validate_and_fix(response)
        
        return ResponseGenerationOutput(
            response_content=response,
            consistency_score=score,
            ...
        )
```

## 四、LangGraph工作流

### 4.1 状态图定义

```python
def create_response_generation_graph() -> StateGraph:
    """创建回复生成图"""
    graph = StateGraph(ResponseGenerationState)
    
    # 添加节点
    graph.add_node("integrate_inputs", integrate_inputs)
    graph.add_node("select_template", select_template)
    graph.add_node("apply_style", apply_style)
    graph.add_node("inject_knowledge", inject_knowledge)
    graph.add_node("validate_consistency", validate_consistency)
    graph.add_node("finalize_output", finalize_output)
    graph.add_node("handle_error", handle_error)
    
    # 设置入口
    graph.set_entry_point("integrate_inputs")
    
    # 添加边
    graph.add_edge("integrate_inputs", "select_template")
    graph.add_edge("select_template", "apply_style")
    graph.add_edge("apply_style", "inject_knowledge")
    graph.add_edge("inject_knowledge", "validate_consistency")
    
    # 条件边：校验失败则重试
    graph.add_conditional_edges(
        "validate_consistency",
        should_retry,
        {
            "retry": "apply_style",
            "continue": "finalize_output"
        }
    )
    
    graph.add_edge("finalize_output", END)
    graph.add_edge("handle_error", END)
    
    return graph
```

### 4.2 工作流状态

```python
class ResponseGenerationState(TypedDict):
    """回复生成状态"""
    input_data: ResponseGenerationInput
    context: Dict[str, Any]
    template: str
    styled_response: str
    enhanced_response: str
    validated_response: str
    final_output: ResponseGenerationOutput
    error: Optional[str]
    retry_count: int
    max_retries: int
```

### 4.3 节点详解

**integrate_inputs** - 整合所有输入要素
- 输入：原始输入数据
- 输出：整合后的上下文

**select_template** - 选择回复模板
- 输入：上下文
- 输出：策略模板

**apply_style** - 应用心理状态风格
- 输入：模板
- 输出：风格化回复

**inject_knowledge** - 注入知识
- 输入：风格化回复
- 输出：知识增强回复

**validate_consistency** - 验证一致性
- 输入：增强回复
- 输出：校验结果，决定是否重试

**finalize_output** - 生成最终输出
- 输入：最终回复
- 输出：结构化输出

## 五、数据流详解

### 5.1 输入数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                        输入数据结构                              │
├─────────────────────────────────────────────────────────────────┤
│  {                                                             │
│    "suspect_profile": {                                        │
│      "personality": ["狡猾"],                                   │
│      "speech_style": ["打官腔"],                                │
│      "background": ["糖尿病"]                                   │
│    },                                                          │
│    "psychological_state": {                                    │
│      "state": "ANXIOUS",                                       │
│      "defense_value": 60,                                      │
│      "stress_value": 55                                        │
│    },                                                          │
│    "dlkg_retrieval": {                                         │
│      "fact_layer": [("嫌疑人","收受","50万")],                  │
│      "false_layer": [],                                        │
│      "casual_layer": []                                        │
│    },                                                          │
│    "selected_strategy": {                                      │
│      "type": "RED_HERRING",                                    │
│      "confidence": 0.85                                        │
│    },                                                          │
│    "interrogator_question": "银行流水显示...",                  │
│    "evidence_strength": 0.7                                    │
│  }                                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 处理数据流

```
┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐
│ 嫌疑人侧写   │   │ 心理状态   │   │ 策略类型   │   │ 证据强度   │
│ 狡猾/官腔   │   │ ANXIOUS   │   │ RED_HERRING│   │   0.7      │
└─────┬──────┘   └──────┬─────┘   └─────┬──────┘   └─────┬──────┘
      │                 │               │                 │
      └─────────────────┴───────────────┴─────────────────┘
                                    ↓
                    ┌──────────────────────────────┐
                    │    策略模板生成               │
                    │ "我……我确实收了钱，但那不是    │
                    │  好处费！是借款..."          │
                    └──────────────┬───────────────┘
                                   ↓
                    ┌──────────────────────────────┐
                    │    心理状态风格化             │
                    │ 添加结巴、重复、省略号        │
                    └──────────────┬───────────────┘
                                   ↓
                    ┌──────────────────────────────┐
                    │    知识库注入                 │
                    │ 融入"收受50万"等事实         │
                    └──────────────┬───────────────┘
                                   ↓
                    ┌──────────────────────────────┐
                    │    一致性校验                 │
                    │ 检查是否与已知事实矛盾        │
                    └──────────────┬───────────────┘
                                   ↓
                    ┌──────────────────────────────┐
                    │    最终回复输出               │
                    │ response_content: str        │
                    │ consistency_score: float     │
                    │ strategy_markers: List[str]  │
                    └──────────────────────────────┘
```

### 5.3 输出数据流

```python
{
  "response_content": "我…… 我确实收了李某 50 万，但那不是好处费！是他公司资金周转不开，硬塞给我的借款...",
  "strategy_markers": ["承认表面事实", "否认犯罪动机", "偷换概念"],
  "emotion_markers": ["结巴", "重复", "焦虑"],
  "new_entities": ["借款借口"],
  "fact_triplets_extracted": [
    ("嫌疑人", "收受", "50万"),
    ("50万", "性质", "借款")
  ],
  "consistency_score": 0.92
}
```

## 六、使用指南

### 6.1 基础使用

```python
from generate_result.models import (
    SuspectProfile, PsychologicalState, PsychologicalStateEnum,
    DLKGRetrievalResult, SelectedStrategy, StrategyTypeEnum,
    ResponseGenerationInput
)
from generate_result.response_generator import ResponseGenerator

# 1. 配置参数
profile = SuspectProfile(
    personality=["狡猾"],
    speech_style=["磕巴"],
    background=[]
)

state = PsychologicalState(
    state=PsychologicalStateEnum.ANXIOUS,
    defense_value=60,
    stress_value=55
)

dlkg = DLKGRetrievalResult(
    fact_layer=[("嫌疑人", "收受", "50万"), ("50万", "来自", "李某")]
)

strategy = SelectedStrategy(
    type=StrategyTypeEnum.RED_HERRING,
    confidence=0.85
)

# 2. 构建输入
input_data = ResponseGenerationInput(
    suspect_profile=profile,
    psychological_state=state,
    dlkg_retrieval=dlkg,
    selected_strategy=strategy,
    interrogator_question="银行流水显示你1月5日收了李某50万，怎么解释？",
    evidence_strength=0.7
)

# 3. 生成回复
generator = ResponseGenerator(input_data)
output = generator.generate_response()

print(output.response_content)
print(f"一致性分数: {output.consistency_score}")
```

### 6.2 使用LangGraph

```python
from generate_result.langgraph.workflow import run_response_generation

result = run_response_generation(input_data, max_retries=2)

if result["success"]:
    print(result["output"].response_content)
else:
    print("生成失败:", result["error"])
```

### 6.3 带LLM的高级版本

```python
from generate_result.response_generator import ResponseGeneratorWithLLM
from openai import OpenAI  # 或其他LLM客户端

llm_client = OpenAI(api_key="your-api-key")

generator = ResponseGeneratorWithLLM(input_data, llm_client=llm_client)
output = generator.generate_response()
```

## 七、扩展点

### 7.1 可扩展的策略

在 `strategy_adapter.py` 的 `STRATEGY_CONFIGS` 字典中添加新策略：

```python
StrategyTypeEnum.NEW_STRATEGY: {
    "core_logic": "新策略逻辑",
    "template_structure": [...],
    "required_elements": [...],
    "strategy_markers": [...],
    "example_responses": [...]
}
```

### 7.2 可扩展的心理状态

在 `psychological_state.py` 的 `STATE_CONFIGS` 字典中添加新状态：

```python
PsychologicalStateEnum.NEW_STATE: {
    "defense_threshold": (min, max),
    "stress_range": (min, max),
    "language_features": {...},
    "behavior_examples": {...}
}
```

### 7.3 自定义LLM客户端

继承 `ResponseGeneratorWithLLM` 并实现自定义逻辑：

```python
class CustomGenerator(ResponseGeneratorWithLLM):
    def _build_llm_prompt(self) -> str:
        # 自定义提示词构建
        ...
    
    def _parse_llm_response(self, response: str) -> str:
        # 自定义响应解析
        ...
```

## 八、总结

回复生成模块通过以下设计实现了高质量的嫌疑人回复生成：

1. **模块化设计**：各组件职责清晰，易于测试和维护
2. **多源联动**：整合侧写、心理、策略、知识四个维度
3. **风格控制**：精细化的心理状态风格应用
4. **一致性保障**：多层次的一致性校验机制
5. **LangGraph工作流**：可观测、可追溯的执行流程
6. **可扩展性**：支持自定义策略、状态、LLM客户端
